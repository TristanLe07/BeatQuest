extends Node2D

# Set this constant before game start
const in_edit_mode: bool = false
var current_level_name = Global.current_level

# Time it takes for falling key to reach critical spot
var fk_fall_time: float = 2.2
var fk_output_arr = [[], [], [], []]

var level_info = {
	"RHYTHM_HELL" = {
		"fk_times": "[[2.52533321380615, 6.55733375549316, 10.5573337554932, 14.5040004730225, 14.6533325195313, 15.5493324279785, 15.6986663818359, 15.9333332061768, 16.0719993591309, 19.76266746521, 22.8666675567627, 27.2293327331543, 30.823998260498, 34.5786674499512, 34.7173316955566, 35.0159996032715, 35.282666015625, 35.4640014648437, 35.6453330993652, 35.9333351135254, 36.1466682434082, 36.2533348083496, 36.3706672668457, 40.4133346557617], [3.03733329772949, 7.0586669921875, 7.28266696929932, 11.5600002288818, 11.8053329467773, 14.9200008392334, 15.0479991912842, 15.282666015625, 15.5813339233398, 16.296000289917, 18.8026664733887, 19.9119995117188, 20.0826671600342, 23.2080009460449, 23.346667098999, 23.9226673126221, 24.3279998779297, 26.792000579834, 27.7200000762939, 28.1253326416016, 31.1759994506836, 31.858666229248, 34.8453338623047, 34.9839981079102, 35.1546676635742, 35.3999984741211, 35.5706680297852, 35.741333770752, 35.8693321228027, 36.0186660766602, 36.1359985351562, 36.2533348083496], [3.56000022888184, 7.54933338165283, 10.7919996261597, 11.0266664505005, 14.5040004730225, 14.6533325195313, 15.5600002288818, 15.7093341827393, 15.9333332061768, 16.0826671600342, 19.0373332977295, 19.1973331451416, 19.3893325805664, 20.274666595459, 20.4026668548584, 23.5493324279785, 23.7093341827393, 24.1146667480469, 27.0159996032715, 27.9333332061768, 31.5280006408691, 32.231999206543], [4.07199983596802, 8.06133346557617, 12.0613334655762, 26.5893333435059, 27.4639995574951]]",
		"music": load("res://Assets/Audio/Rhythm Hell.mp3")
	},
	"RAINCLOUDS" = {
		"fk_times": "[[21.3360778808594, 21.8907024383545, 22.1040355682373, 23.1706344604492, 23.5652839660645, 23.9599315643311, 24.2585708618164, 24.8025390625, 24.983878326416, 26.1251480102539, 26.4984580993652, 26.8717681884766, 27.2130844116211, 27.6930610656738, 27.8957149505615, 28.9836513519287, 29.3889801025391, 29.7622901916504, 30.1142646789551, 30.6795684814453, 30.8395683288574, 31.9595024108887, 32.3541481018066, 32.7168037414551, 33.0794326782227, 33.6127426147461, 33.8260757446289, 34.9353515625, 35.3193199157715, 35.6713134765625, 36.0339462280273, 36.5565979003906, 36.7592498779297, 37.8471900939941, 38.231177520752, 38.5938102722168, 38.956462097168, 39.5644218444824, 39.7564155578613, 40.8123580932617, 41.16435546875, 41.559001159668, 41.9216339111328, 42.4549438476563, 42.6362602233887, 43.7775527954102, 44.1401817321777, 44.5241729736328, 44.8654891967773, 45.4841262817383, 46.7427207946777, 47.4466888427734, 47.8199989318848, 48.3853065490723, 49.6652366638184, 50.3905212402344, 50.7531730651856, 51.3077995300293, 52.5664169311523, 53.7503387451172, 54.262313079834, 55.5529243469238, 56.2888671875, 56.6515190124512, 57.163493347168, 58.5180961608887, 59.616690826416, 60.1180030822754, 61.4619285583496, 62.1872360229492, 62.5498840332031, 63.0511810302734, 64.3524505615234, 64.7684356689453, 65.1630584716797, 65.515055847168, 66.0163528442383, 67.3602935791016, 68.1495697021484, 68.4695693969727, 68.9708587646484, 70.2614776611328, 71.0080978393555, 71.3707458496094, 71.8720428466797, 76.1278259277344, 76.8851272583008, 77.3117706298828, 77.8237411499023, 79.0929901123047, 79.8076202392578, 80.2129470825195, 80.7355758666992, 82.0155136108398, 82.794123840332, 83.2101165771484, 83.6794082641602, 85.0020172119141, 85.7166473388672, 86.0686141967773, 86.6446029663086, 87.9351913452148, 88.6605026245117, 89.0444671630859, 89.5564376831055, 90.8470260620117, 91.6043273925781, 91.9989807128906, 99.7319061279297, 100.307872009277, 103.774356079102], [57.366145324707, 63.2645141601563, 66.2083465576172, 72.0746948242188, 78.0157119750977, 79.4556457519531, 80.9488861083984, 86.8365737915039, 88.3085052490234, 93.8335372924805, 100.841181945801], [54.4649650573731, 55.9262344360352, 58.9127456665039, 64.7364151000977, 73.1733123779297, 73.7172805786133, 74.3145782470703, 82.420817565918, 89.7484390258789, 91.2416793823242, 93.8228790283203, 94.3561889648438, 94.8894989013672, 96.7453948974609, 97.3000213623047, 97.8653289794922], [22.082698059082, 23.5439464569092, 25.0052158355713, 26.4664623260498, 27.9063941955566, 29.3889801025391, 30.8608848571777, 32.3648063659668, 33.8260757446289, 35.3300010681152, 36.8019058227539, 38.231177520752, 39.7990943908691, 41.1856681823731, 42.6575958251953, 44.1295234680176, 45.6761009216309, 47.1053726196289, 48.5772773742676, 50.0278694152832, 51.5317909240723, 52.9397270202637, 60.3419944763184, 61.8245803833008, 67.7229263305664, 69.173518371582, 70.6347839355469, 74.9118835449219, 76.5544692993164, 83.8607513427734, 85.3326751708984, 103.059725952148]]",
		"music": load("res://Assets/Audio/doyoustillthinkofmejang0prod.wav")
	}
}

# Called when the node enters the scene tree for the first time.
func _ready():
	
	$MusicPlayer.stream = level_info.get(current_level_name).get("music")
	$MusicPlayer.play()
	
	if in_edit_mode:
		Signals.KeyListenerPress.connect(KeyListenerPress)
	else:
		var fk_times = level_info.get(current_level_name).get("fk_times")
		var fk_times_arr = str_to_var(fk_times)
		
		var counter: int = 0
		for key in fk_times_arr:
			
			var button_name: String = ""
			match counter:
				0:
					button_name = "button_Q"
				1:
					button_name = "button_W"
				2:
					button_name = "button_E"
				3:
					button_name = "button_R"
			
			for delay in key:
				SpawnFallingKey(button_name, delay)
			
			counter += 1

func KeyListenerPress(button_name: String, array_num: int):
	#print(str(array_num) + " " + str($MusicPlayer.get_playback_position()))
	fk_output_arr[array_num].append($MusicPlayer.get_playback_position() - fk_fall_time)

func SpawnFallingKey(button_name: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Signals.CreateFallingKey.emit(button_name)


func _on_music_player_finished():
	if in_edit_mode:
		print(fk_output_arr)
	elif Global.current_scene == "world":
		get_tree().change_scene_to_file("res://Scenes/World/room_1.tscn")	
	else:
		get_tree().change_scene_to_file("res://Scenes/World/room_2.tscn")
